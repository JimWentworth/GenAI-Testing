#!/usr/bin/env node
import { promises as fs } from 'fs';
import path from 'path';

const repoRoot = process.cwd();
const interactionsDir = path.join(repoRoot, 'interactions', 'h5p');

await fs.mkdir(interactionsDir, { recursive: true });

function stripHtml(value = '') {
  return value
    .replace(/<script[\s\S]*?<\/script>/gi, '')
    .replace(/<style[\s\S]*?<\/style>/gi, '')
    .replace(/<[^>]+>/g, ' ')
    .replace(/&nbsp;/gi, ' ')
    .replace(/&amp;/gi, '&')
    .replace(/&lt;/gi, '<')
    .replace(/&gt;/gi, '>')
    .replace(/&quot;/gi, '"')
    .replace(/&#39;/gi, "'")
    .replace(/\s+/g, ' ')
    .trim();
}

function escapeHtml(value = '') {
  return value
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function escapeAttribute(value = '') {
  return escapeHtml(value).replace(/`/g, '&#96;');
}

function parseOrderFromName(name) {
  const match = name.match(/^(\d+)/);
  return match ? Number.parseInt(match[1], 10) : Number.POSITIVE_INFINITY;
}

function parseOrderFromHtml(html) {
  const orderMatch = html.match(/data-(?:order|index)\s*=\s*"?(\d+)/i);
  return orderMatch ? Number.parseInt(orderMatch[1], 10) : undefined;
}

function extractMeta(html, fallbackName) {
  const titleMatch = html.match(/<title[^>]*>([^<]+)<\/title>/i);
  const headingMatch = html.match(/<h1[^>]*>([\s\S]*?)<\/h1>/i);
  const paragraphMatch = html.match(/<p[^>]*>([\s\S]*?)<\/p>/i);
  const metaDescMatch = html.match(/<meta[^>]+name=["']description["'][^>]+content=["']([^"']+)["'][^>]*>/i);

  const title = titleMatch ? stripHtml(titleMatch[1]) : fallbackName;

  let description = '';
  if (metaDescMatch) {
    description = stripHtml(metaDescMatch[1]);
  } else if (headingMatch) {
    description = stripHtml(headingMatch[1]);
  } else if (paragraphMatch) {
    description = stripHtml(paragraphMatch[1]);
  }

  const order = parseOrderFromHtml(html);

  return {
    title: title || fallbackName,
    description,
    order,
  };
}

async function safeRead(filePath) {
  try {
    return await fs.readFile(filePath, 'utf8');
  } catch (error) {
    if (error.code !== 'ENOENT') {
      console.warn(`Warning: unable to read ${filePath}:`, error.message);
    }
    return null;
  }
}

function humanize(value) {
  return value
    .replace(/[-_]+/g, ' ')
    .replace(/\s+/g, ' ')
    .trim()
    .replace(/\b\w/g, (char) => char.toUpperCase()) || value;
}

function buildCardMarkup(interaction, index) {
  const number = String(index + 1).padStart(2, '0');
  const safeTitle = escapeHtml(interaction.title);
  const safeDescriptionHtml = interaction.description
    ? `<p class="card-description">${escapeHtml(interaction.description)}</p>`
    : '';
  const safeTitleAttr = escapeAttribute(interaction.title.toLowerCase());
  const safeDescriptionAttr = escapeAttribute((interaction.description ?? '').toLowerCase());
  return `      <li class="card" data-title="${safeTitleAttr}" data-description="${safeDescriptionAttr}">
        <span class="card-number">${number}</span>
        <div class="card-body">
          <h3 class="card-title">${safeTitle}</h3>
          ${safeDescriptionHtml}
        </div>
        <div class="card-actions">
          <a class="card-link" href="${interaction.href}" target="_blank" rel="noopener">Open</a>
        </div>
      </li>`;
}

function buildHtml(interactions) {
  const cardsMarkup = interactions.map(buildCardMarkup).join('\n');
  const hasInteractions = interactions.length > 0;

  const generatedAt = new Date().toISOString();

  return `<!DOCTYPE html>
<!-- Generated by scripts/build-h5p-index.mjs on ${generatedAt}. -->
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GenAI Fluency – H5P Interaction Library</title>
    <meta name="description" content="Open, explore, and share H5P-style HTML interactions for teaching GenAI fluency." />
    <style>
      :root {
        color-scheme: light;
        --page-bg: #f4f6fb;
        --card-bg: #ffffff;
        --card-border: rgba(15, 23, 42, 0.08);
        --text-primary: #0f172a;
        --text-secondary: #475569;
        --accent: #1d4ed8;
        --accent-soft: rgba(29, 78, 216, 0.12);
        --shadow: 0 20px 45px -20px rgba(15, 23, 42, 0.35);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        color: var(--text-primary);
        background: var(--page-bg);
        line-height: 1.6;
      }

      .site-header {
        background: linear-gradient(135deg, #1d4ed8, #1e40af);
        color: #ffffff;
        padding: 3.5rem 1.5rem 4.5rem;
      }

      .header-content {
        max-width: 960px;
        margin: 0 auto;
      }

      .eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-weight: 600;
        font-size: 0.75rem;
        opacity: 0.9;
        margin-bottom: 0.75rem;
      }

      .header-title {
        font-size: clamp(2rem, 5vw, 2.75rem);
        font-weight: 700;
        margin: 0 0 1rem;
      }

      .header-description {
        font-size: clamp(1rem, 3vw, 1.15rem);
        max-width: 720px;
        margin: 0 0 1.25rem;
        opacity: 0.92;
      }

      .usage-note {
        font-size: 0.95rem;
        max-width: 720px;
        margin: 0;
        opacity: 0.85;
      }

      main {
        max-width: 1100px;
        margin: -2.5rem auto 0;
        padding: 0 1.5rem 4rem;
      }

      .search-bar {
        background: #ffffff;
        border-radius: 1rem;
        padding: 1rem 1.25rem;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 2rem;
      }

      .search-bar input[type="search"] {
        flex: 1;
        font: inherit;
        border: none;
        outline: none;
        padding: 0.5rem 0;
        color: var(--text-primary);
      }

      .search-bar input::placeholder {
        color: rgba(71, 85, 105, 0.7);
      }

      .search-bar .search-icon {
        width: 1.25rem;
        height: 1.25rem;
        color: rgba(148, 163, 184, 0.9);
      }

      .card-grid {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        counter-reset: card-counter;
      }

      .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .card {
        background: var(--card-bg);
        border-radius: 1.25rem;
        padding: 1.75rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--card-border);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        position: relative;
        transition: transform 160ms ease, box-shadow 160ms ease;
      }

      .card::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: linear-gradient(135deg, rgba(29, 78, 216, 0.08), transparent 60%);
        opacity: 0;
        transition: opacity 160ms ease;
      }

      .card:hover {
        transform: translateY(-6px);
        box-shadow: 0 28px 50px -28px rgba(15, 23, 42, 0.55);
      }

      .card:hover::after {
        opacity: 1;
      }

      .card-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 0.75rem;
        background: var(--accent-soft);
        color: var(--accent);
        font-weight: 700;
        font-size: 0.95rem;
      }

      .card-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        line-height: 1.35;
      }

      .card-description {
        margin: 0.5rem 0 0;
        color: var(--text-secondary);
        font-size: 0.95rem;
        line-height: 1.5;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .card-actions {
        margin-top: auto;
      }

      .card-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.25rem;
        border-radius: 0.75rem;
        font-weight: 600;
        text-decoration: none;
        background: var(--accent);
        color: #ffffff;
        transition: background 160ms ease, transform 160ms ease;
      }

      .card-link:hover,
      .card-link:focus-visible {
        background: #1e3a8a;
        transform: translateY(-1px);
      }

      .empty-state {
        margin: 3rem auto;
        max-width: 560px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 1rem;
        padding: 1.75rem;
        text-align: center;
        color: var(--text-secondary);
        box-shadow: var(--shadow);
        border: 1px solid var(--card-border);
      }

      footer {
        padding: 2.5rem 1.5rem;
        background: #0f172a;
        color: rgba(255, 255, 255, 0.8);
        text-align: center;
        font-size: 0.95rem;
      }

      footer a {
        color: #bfdbfe;
        text-decoration: none;
        font-weight: 600;
      }

      footer a:hover,
      footer a:focus-visible {
        text-decoration: underline;
      }

      @media (max-width: 640px) {
        .site-header {
          padding: 2.75rem 1.25rem 4rem;
        }

        main {
          padding: 0 1.25rem 3.5rem;
        }

        .card {
          padding: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="header-content">
        <p class="eyebrow">GenAI Fluency — Interaction Library</p>
        <h1 class="header-title">Standalone H5P HTML Interactions</h1>
        <p class="header-description">Browse, preview, and share the GenAI Fluency H5P-style interactions. Open any activity directly in the browser or embed it inside your LMS as an HTML page.</p>
        <p class="usage-note">Compatibility note: These HTML exports work best in modern browsers (Chrome, Edge, Firefox). Some interactive features may not be available in legacy or mobile browsers.</p>
      </div>
    </header>
    <main>
      <section class="search-bar">
        <svg class="search-icon" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M21 20.3 16.65 16a7 7 0 1 0-.7.7L20.3 21zM5 11a6 6 0 1 1 6 6 6 6 0 0 1-6-6" />
        </svg>
        <label class="visually-hidden" for="search">Search interactions</label>
        <input id="search" type="search" placeholder="Search interactions by title or description" autocomplete="off" spellcheck="false" />
      </section>
      ${hasInteractions ? `<ol class="card-grid" id="card-grid">
${cardsMarkup}
      </ol>` : `<ol class="card-grid" id="card-grid"></ol>`}
      <p class="empty-state" data-role="empty-initial"${hasInteractions ? ' hidden' : ''}>No interactions have been added yet. Add exported H5P HTML packages to this folder to populate the library.</p>
      <p class="empty-state" data-role="empty-search" hidden>No interactions match your search. Try a different keyword.</p>
    </main>
    <footer>
      Prototype created by the Center for Innovation in Teaching and Learning. Contact <a href="mailto:citl-info@illinois.edu">citl-info@illinois.edu</a> with questions or feedback.
    </footer>
    <script>
      const interactions = ${JSON.stringify(interactions, null, 2)};
      const searchInput = document.getElementById('search');
      const cardGrid = document.getElementById('card-grid');
      const initialEmpty = document.querySelector('[data-role="empty-initial"]');
      const searchEmpty = document.querySelector('[data-role="empty-search"]');

      function createCard(interaction, index) {
        const listItem = document.createElement('li');
        listItem.className = 'card';
        listItem.dataset.title = (interaction.title || '').toLowerCase();
        listItem.dataset.description = (interaction.description || '').toLowerCase();

        const numberSpan = document.createElement('span');
        numberSpan.className = 'card-number';
        numberSpan.textContent = String(index + 1).padStart(2, '0');

        const body = document.createElement('div');
        body.className = 'card-body';

        const titleEl = document.createElement('h3');
        titleEl.className = 'card-title';
        titleEl.textContent = interaction.title;
        body.appendChild(titleEl);

        if (interaction.description) {
          const descriptionEl = document.createElement('p');
          descriptionEl.className = 'card-description';
          descriptionEl.textContent = interaction.description;
          body.appendChild(descriptionEl);
        }

        const actions = document.createElement('div');
        actions.className = 'card-actions';

        const link = document.createElement('a');
        link.className = 'card-link';
        link.href = interaction.href;
        link.target = '_blank';
        link.rel = 'noopener';
        link.textContent = 'Open';

        actions.appendChild(link);

        listItem.append(numberSpan, body, actions);

        return listItem;
      }

      function populateCards() {
        cardGrid.innerHTML = '';
        const fragment = document.createDocumentFragment();
        interactions.forEach((interaction, index) => {
          fragment.appendChild(createCard(interaction, index));
        });
        cardGrid.appendChild(fragment);

        const hasCards = interactions.length > 0;
        if (!hasCards) {
          searchInput.setAttribute('disabled', '');
        }
        if (initialEmpty) {
          initialEmpty.hidden = hasCards;
        }
      }

      function filterCards() {
        const query = searchInput.value.trim().toLowerCase();
        const cards = Array.from(cardGrid.querySelectorAll('.card'));

        if (cards.length === 0) {
          if (searchEmpty) {
            searchEmpty.hidden = true;
          }
          return;
        }

        let visibleCount = 0;
        cards.forEach((card) => {
          const haystack = card.dataset.title + ' ' + card.dataset.description;
          const matches = haystack.includes(query);
          card.hidden = !matches;
          if (matches) {
            visibleCount += 1;
          }
        });

        if (query.length > 0) {
          if (searchEmpty) {
            searchEmpty.hidden = visibleCount !== 0;
          }
          if (initialEmpty) {
            initialEmpty.hidden = true;
          }
        } else {
          if (searchEmpty) {
            searchEmpty.hidden = true;
          }
          if (initialEmpty) {
            initialEmpty.hidden = interactions.length !== 0;
          }
        }
      }

      populateCards();
      filterCards();
      searchInput.addEventListener('input', filterCards);
    </script>
  </body>
</html>\n`;
}

const entries = await fs.readdir(interactionsDir, { withFileTypes: true }).catch(() => []);

const interactions = [];

for (const entry of entries) {
  if (entry.name.startsWith('.')) {
    continue;
  }

  if (entry.isDirectory()) {
    const folderPath = path.join(interactionsDir, entry.name);
    const indexPath = path.join(folderPath, 'index.html');
    const html = await safeRead(indexPath);
    if (!html) {
      continue;
    }
    const meta = extractMeta(html, humanize(entry.name));
    interactions.push({
      title: meta.title,
      description: meta.description,
      href: encodeURI(`${entry.name}/index.html`),
      order: meta.order ?? parseOrderFromName(entry.name),
    });
  } else if (entry.isFile() && entry.name.endsWith('.html') && entry.name !== 'index.html') {
    const filePath = path.join(interactionsDir, entry.name);
    const html = await safeRead(filePath);
    if (!html) {
      continue;
    }
    const baseName = entry.name.replace(/\.html$/i, '');
    const meta = extractMeta(html, humanize(baseName));
    interactions.push({
      title: meta.title,
      description: meta.description,
      href: encodeURI(entry.name),
      order: meta.order ?? parseOrderFromName(baseName),
    });
  }
}

interactions.sort((a, b) => {
  const orderA = a.order ?? Number.POSITIVE_INFINITY;
  const orderB = b.order ?? Number.POSITIVE_INFINITY;
  if (orderA !== orderB) {
    return orderA - orderB;
  }
  return a.title.localeCompare(b.title);
});

const html = buildHtml(interactions);
await fs.writeFile(path.join(interactionsDir, 'index.html'), html, 'utf8');

console.log(`Generated interactions index with ${interactions.length} entr${interactions.length === 1 ? 'y' : 'ies'}.`);
